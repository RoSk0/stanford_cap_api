<?php
/**
 * @file
 * Code for the Stanford CAP API feature.
 */

include_once 'stanford_cap_api.features.inc';

/**
 * Implements hook_menu().
 */
function stanford_cap_api_menu() {
  $items = array();

  $items['admin/config/cap'] = array(
    'title' => 'Community Academic Profiles',
    'description' => 'Community Academic Profiles API screens.',
    'position' => 'right',
    'weight' => -5,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  $items['admin/config/cap/details'] = array(
    'title' => 'Details',
    'description' => "Displays information about the site's connection to the CAP API.",
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_cap_api_details_form'),
    // @todo Proper access check.
    'access callback' => TRUE,
    'weight' => -10,
    'file' => 'stanford_cap_api.admin.inc',
  );

  $items['admin/config/cap/settings'] = array(
    'title' => 'Settings',
    'description' => 'Provides administrators ability to change CAP API access settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_cap_api_settings_form'),
    // @todo Proper access check.
    'access callback' => TRUE,
    'weight' => 10,
    'file' => 'stanford_cap_api.admin.inc',
  );

  $items['admin/config/cap/import'] = array(
    'title' => 'Import profiles',
    'description' => 'Provides administrators ability to import CAP profiles.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_cap_api_import_form'),
    // @todo Proper access check.
    'access callback' => TRUE,
    'weight' => 5,
    'file' => 'stanford_cap_api.admin.inc',
  );

  $items['admin/config/cap/import/result'] = array(
    'title' => 'Import profiles',
    'description' => 'Provides administrators ability to import CAP profiles.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_cap_api_import_result_form'),
    // @todo Proper access check.
    'access callback' => TRUE,
    'file' => 'stanford_cap_api.admin.inc',
  );

  $items['admin/config/cap/profile_test'] = array(
    'title' => 'Faculty Profile Structure Synchronization',
    'description' => 'Faculty Profile Structure Synchronization',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_cap_api_profile_test'),
    // @todo Proper access check.
    'access callback' => TRUE,
    'file' => 'stanford_cap_api.admin.inc',
  );

  $items['admin/config/cap/manage'] = array(
    'title' => 'Manage profiles',
    'description' => 'Provides administrators ability to manage CAP profiles.',
    'page callback' => 'stanford_cap_api_manage',
    // @todo Proper access check.
    'access callback' => TRUE,
    'weight' => 6,
    'file' => 'stanford_cap_api.admin.inc',
  );

  return $items;
}

/**
 * Synchronize fields from CAP profile to Drupal.
 *
 * @param array $profile
 *   CAP profile.
 */
function stanford_cap_api_synchronize_fields(&$profile) {

  $drupal_fields = array();
  foreach ($profile as $field_name => &$field_data) {
    $node_field_name = _cap_api_generate_field_name($field_name);
    // Saving field name for further usage.
    $drupal_fields[$node_field_name] = $field_name;
    $field_info = field_info_field($node_field_name);
    // Field not exists yet.
    if (empty($field_info)) {
      // @todo Here we should grab field metadata from JSON schema.
      $field_type = _cap_api_get_field_type($field_name);
      $field_info = _cap_api_get_field_base_def($field_type, $node_field_name);
      // Do we know about this field type?
      if (!empty($field_info)) {
        field_create_field($field_info);
        // Logging field creation.
        _cap_api_log_field($node_field_name);
        $field_instance = field_info_instance('node', $node_field_name, 'cap_faculty_profile');
        if (empty($field_instance)) {
          // @todo Grab field label from JSON schema.
          $field_instance = _cap_api_get_field_instance_def($field_type, $node_field_name, $field_name);
          field_create_instance($field_instance);
        }
        if ($field_type == 'field_collection') {
          _cap_api_sync_subfields($field_data, $node_field_name);
        }
      }
    }
  }
  // Saving mapping of original fields to Drupal fields.
  $profile['drupal_fields'] = $drupal_fields;
}

/**
 * Implements hook_menu_alter().
 */
function stanford_cap_api_menu_alter(&$items) {
  $items['node/%node/edit']['access callback'] = 'stanford_cap_api_node_access';
  $items['admin/structure/types/manage/%node_type/fields']['access callback'] = 'stanford_cap_api_user_access';
  $items['admin/structure/types/manage/%node_type/fields']['access arguments'][] = 4;
}

/**
 * Access check callback.
 */
function stanford_cap_api_node_access($op, $node) {
  $access = node_access($op, $node);
  if ($access && $node->type == 'cap_faculty_profile') {
    if (!variable_get('cap_allow_edit', FALSE)) {
      $access = FALSE;
    }
  }

  return $access;
}

/**
 * Access check callback.
 */
function stanford_cap_api_user_access($permission, $node_type) {
  $access = user_access($permission);
  if ($access && $node_type->type == 'cap_faculty_profile') {
    if (!variable_get('cap_custom_fields', FALSE)) {
      $access = FALSE;
    }
  }

  return $access;
}

/**
 * Authenticate with CAP and return an authentication token.
 *
 * @param string $user
 *   User name to use to authenticate in CAP API instead of saved one.
 * @param string $pass
 *   Password to use to authenticate in CAP API instead of saved one.
 *
 * @return string|FALSE
 *   An authentication token that can be used for API calls or FALSE.
 */
function stanford_cap_api_auth($user = '', $pass = '') {

  $auth_uri = variable_get('cap_auth_uri', 'https://authz-test.stanford.edu/oauth/token');
  $user = empty($user) ? variable_get('cap_username', '') : $user;
  $pass = empty($pass) ? variable_get('cap_password', '') : $pass;

  $params = array(
    'grant_type' => 'client_credentials',
    'scope' => 'profiles.read_public',
  );

  if (empty($user) || empty($pass)) {
    return FALSE;
  }

  // Append user/pass, some system doesn't support http_build_url.
  $uri = parse_url($auth_uri);

  $host = $user . ':' . $pass . '@' . $uri['host'];
  $auth_url = str_replace($uri['host'], $host, $auth_uri);

  $auth_url = url($auth_url, array('query' => $params, 'external' => TRUE));
  $response = drupal_http_request($auth_url);
  // Error could be here as well.
  if (property_exists($response, 'error')) {
    $error_msg = 'Failed to fetch data from CAP API service. Error code is'
      . ' %code, error message is "%msg", request string was "%request".';
    $vars = array(
      '%code' => $response->code,
      '%msg' => $response->status_message,
      '%request' => $response->request,
    );
    watchdog('stanford_cap_api', $error_msg, $vars, WATCHDOG_WARNING);

    return FALSE;
  }

  // Log bad API authentication.
  $data = json_decode($response->data, TRUE);
  if (array_key_exists('error', $data)) {
    $error_msg = 'Error found in CAP API response. Error message is "%msg",'
      . ' response data was "%data".';
    $vars = array(
      '%msg' => $data['error_description'],
      '%data' => print_r($data, TRUE),
    );
    watchdog('stanford_cap_api', $error_msg, $vars, WATCHDOG_WARNING);

    return FALSE;
  }

  // Authentication successful, return the access token.
  if (array_key_exists('access_token', $data)) {
    return $data['access_token'];
  }

  return FALSE;
}

/**
 * Issue an API call against an API endpoint.
 */
function stanford_cap_api_request($endpoint, $params = array()) {
  // Real endpoint is "http://irt-dev.stanford.edu/cap-api"
  $api_base = variable_get('cap_api_base_url', 'http://irt-dev.stanford.edu/cap-api');

  $access_token = stanford_cap_api_auth();
  // Unable to fetch an auth token.
  if (!$access_token) {
    return FALSE;
  }

  $query = array(
    'access_token' => $access_token,
  );

  $request_url = url($api_base . $endpoint, array(
    'query' => $params += $query,
    'external' => TRUE,
  ));

  $response = drupal_http_request($request_url);
  // Error could be here as well.
  if (property_exists($response, 'error')) {
    $error_msg = 'Failed to fetch data from CAP API service. Error code is'
      . ' %code, error message is "%msg", request string was "%request".';
    $vars = array(
      '%code' => $response->code,
      '%msg' => $response->status_message,
      '%request' => $response->request,
    );
    watchdog('stanford_cap_api', $error_msg, $vars, WATCHDOG_WARNING);

    return FALSE;
  }

  // Log bad API authentication.
  $data = json_decode($response->data, TRUE);
  if (array_key_exists('error', $data)) {
    $error_msg = 'Error found in CAP API response. Error message is "%msg",'
      . ' response data was "%data".';
    $vars = array(
      '%msg' => $data['error_description'],
      '%data' => print_r($data, TRUE),
    );
    watchdog('stanford_cap_api', $error_msg, $vars, WATCHDOG_WARNING);

    return FALSE;
  }
  else {
    return $data;
  }
}

function stanford_cap_api_test() {
  $endpoint = '/api/cap/v1/orgs';
  $params = array('orgCodes' => 'VAAA');

  $response = stanford_cap_api_request($endpoint, $params);
  dpm($response, 'Raw response');
}

/**
 * Save organization fetch from CAP API.
 *
 * @param array $organization
 *   Array containing organization description.
 * @param int $orgid
 *   Organization ID inside Stanford University. Could be 0 for root entry,
 * Stanford University itself.
 */
function stanford_cap_api_save_organization($organization, $orgid = 0) {
  $organization['orgid'] = $orgid;
  if (isset($organization['children'])) {
    $childrens = $organization['children'];
    $childrens_id = array();
    foreach ($childrens as $orgid => $org) {
      $childrens_id[] = $orgid;
      stanford_cap_api_save_organization($org, $orgid);
    }
    $organization['children'] = $childrens_id;
  }
  drupal_write_record('cap_api_orgs', $organization);
}

/**
 * Imports organizations from CAP API.
 *
 * Organizations have tree structure. To import them we must specify top level
 * organization code. This can be code of root entry - Stanford University(AA00)
 * itself, or code of one of departments, like School of Medicine(VAAA).
 *
 * @param string $top
 *   Top level organization code.
 */
function stanford_cap_api_import_organizations($top = 'AA00') {
  db_delete('cap_api_orgs')->execute();
  // Organizations endpoint.
  $endpoint = '/api/cap/v1/orgs';
  $params = array('orgCodes' => $top);
  $data = stanford_cap_api_request($endpoint, $params);
  foreach ($data as $orgid => $organization) {
    stanford_cap_api_save_organization($organization, $orgid);
  }
}

/**
 * Implements hook_cron().
 */
function stanford_cap_api_cron() {
  $last_run_time = variable_get('stanford_cap_api_cron_last_run', 0);
  $time_since_last_run = REQUEST_TIME - $last_run_time;
  // Check if last run was more then one day ago.
  if ($time_since_last_run > 86400) {
    stanford_cap_api_import_organizations();
    stanford_cap_api_update_profiles();
    // Update execution time.
    variable_set('stanford_cap_api_cron_last_run', REQUEST_TIME);
  }
}

/**
 * Import CAP profile.
 *
 * @param int $profile_id
 *   Profile ID.
 */
function stanford_cap_api_profile_import($profile_id) {
  if (isset($_SESSION['search_response']['values'])) {
    foreach ($_SESSION['search_response']['values'] as $profile) {
      if ($profile['profileId'] == $profile_id) {
        stanford_cap_api_synchronize_fields($profile);
        stanford_cap_api_profile_sync($profile);
      }
    }
  }
  else {
    $profile = stanford_cap_api_request('/api/profiles/v1/' . $profile_id);
    if ($profile) {
      stanford_cap_api_synchronize_fields($profile);
      stanford_cap_api_profile_sync($profile);
    }
    else {
      $message = 'There is no profile with ID %id in Stanford CAP Network.';
      watchdog('stanford_cap_api', $message, array('%id' => $profile_id));
    }
  }
}

function stanford_cap_api_import_result_finished() {
  drupal_set_message(t('Profiles imported!'));
  unset($_SESSION['search_params']);
  unset($_SESSION['search_response']);
  drupal_goto('admin/config/cap/import');
}

/**
 * Synchronize CAP network profile with Drupal node.
 *
 * @param array $profile
 *   CAP network profile.
 */
function stanford_cap_api_profile_sync($profile) {
  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'cap_faculty_profile')
    ->fieldCondition('cap_profileid', 'value', $profile['profileId'])
    ->execute();
  if (isset($result['node']) && count($result['node']) == 1) {
    $node = array_shift($result['node']);
    $node = node_load($node->nid);
    stanford_cap_api_node_fields_update($node, $profile);
  }
  elseif (isset($result['node']) && count($result['node']) > 1) {
    // More then 1 node contains this profile's ID, error?
    // @todo Add more description.
    watchdog('stanford_cap_api', 'Error! More than one node per profile.');
  }
  else {
    // Importing.
    $node = new stdClass();
    $node->title = $profile['displayName'];
    $node->uid = 0;
    $node->status = 1;
    $node->type = 'cap_faculty_profile';
    $node->created = REQUEST_TIME;
    $node->changed = REQUEST_TIME;
    $node->is_new = TRUE;
    $node->language = LANGUAGE_NONE;
    node_save($node);
    $node = node_load($node->nid, NULL, TRUE);
    stanford_cap_api_node_fields_update($node, $profile);
  }
}

/**
 * Sync profile fields to node.
 *
 * @param $node
 * @param $profile
 */
function stanford_cap_api_node_fields_update($node, $profile) {
  $nw = entity_metadata_wrapper('node', $node);

  foreach ($profile as $field_name => $field_data) {
    _cap_api_save_field($node, $nw, $field_name, $field_data);
  }

  $nw->cap_profile_link->set(array('url' => _cap_api_format_cap_profile_url($profile)));
  $nw->cap_sync_date->set(REQUEST_TIME);
  $nw->save();
}

/**
 * Import multiply CAP profiles.
 *
 * @param array $profile_ids
 *   Array of profile ID's.
 */
function stanford_cap_api_profile_import_multiply($profile_ids) {
  $params = array(
    'ids' => implode(',', $profile_ids),
    'ps' => count($profile_ids),
  );
  $profiles = stanford_cap_api_request('/api/profiles/v1', $params);
  foreach ($profiles['values'] as $profile) {
    stanford_cap_api_synchronize_fields($profile);
    stanford_cap_api_profile_sync($profile);
  }
  $message = 'Successfully imported %count profiles from Stanford CAP Network.';
  watchdog('stanford_cap_api', $message, array('%count' => $profiles['count']));
}

/**
 * Updates already imported profiles.
 */
function stanford_cap_api_update_profiles() {
  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'cap_faculty_profile')
    ->fieldCondition('cap_profileid', 'value', '', '<>')
    ->execute();
  if (count($result['node'])) {
    $nids = array_keys($result['node']);
    $nodes = node_load_multiple($nids);
    $profile_ids = array();
    foreach ($nodes as $node) {
      $nw = entity_metadata_wrapper('node', $node);
      $profile_ids[] = $nw->cap_profileid->value();
    }
    stanford_cap_api_profile_import_multiply($profile_ids);
  }
}

function cap_api_schema_test() {
  $product = file_get_contents(drupal_get_path('module', 'stanford_cap_api') . '/profile.json');
  $product = json_decode($product);

  $product_schema = file_get_contents(drupal_get_path('module', 'stanford_cap_api') . '/profile_schema.json');
  $product_schema = json_decode($product_schema);
  dpm($product, 'Profile');
  dpm($product_schema, 'Profile schema');
}

/**
 * Updates fields of collections.
 *
 * @param $wrapper
 * @param $subfield
 * @param $data
 */
function _cap_api_node_fields_update_subfields(&$wrapper, $subfield, $data) {
  $fc_field_name = _cap_api_get_subfield_name($subfield);
  switch ($subfield) {
    // Default.
    case 'appointment':
    case 'organization':
      $wrapper->{$fc_field_name}->set($data);
      break;

    case 'startYear':
    case 'endYear':
      $wrapper->{$fc_field_name}->set(strtotime($data->value));
      break;

    case 'label':
      if (is_string($data)) {
        $wrapper->{$fc_field_name}->set($data->html);
      }
      elseif (is_object($data)) {
        $wrapper->{$fc_field_name}->set($data->html);
      }
      break;
  }
}

/**
 * Introduce field type while we have no JSON schema.
 *
 * @todo Drop as we will get access to JSON schema.
 */
function _cap_api_get_field_type($field_name) {
  $type = FALSE;
  switch ($field_name) {
    case 'abstract':
    case 'academicYear':
    case 'academicYear8':
    case 'activity':
    case 'address':
    case 'address2':
    case 'alias':
    case 'apaCitation':
    case 'apiLabel':
    case 'appointment':
    case 'californiaPhysicianLicense':
    case 'catalogNumber':
    case 'chicagoCitation':
    case 'city':
    case 'contentType':
    case 'dates':
    case 'degree':
    case 'department':
    case 'description':
    case 'details':
    case 'display':
    case 'displayName':
    case 'doiId':
    case 'email':
    case 'etag':
    case 'fax':
    case 'fieldOfStudy':
    case 'firstName':
    case 'fullName':
    case 'institution':
    case 'key':
    case 'lab':
    case 'label':
    case 'lastName':
    case 'latitude':
    case 'location':
    case 'longitude':
    case 'middleName':
    case 'mlaCitation':
    case 'name':
    case 'officeName':
    case 'org':
    case 'organizations':
    case 'orgCode':
    case 'patentAssignee':
    case 'patentInventor':
    case 'patentNumber':
    case 'patentTitle':
    case 'personalInterests':
    case 'personalUrlText':
    case 'phone':
    case 'populationServed':
    case 'position':
    case 'presentedTo':
    case 'profileShortDesc':
    case 'projectTitle':
    case 'pubMedId':
    case 'quarter':
    case 'refPatentCountryCode':
    case 'refPatentCountryText':
    case 'rel':
    case 'researchDesc':
    case 'researchUrlText':
    case 'role':
    case 'specificLocation':
    case 'state':
    case 'subject':
    case 'subjectCode':
    case 'title':
    case 'topic':
    case 'type':
    case 'uid':
    case 'webOfScienceId':
    case 'yearIssued':
    case 'zip':
      $type = 'string';
      break;

    case 'clinicalFocus':
    case 'phoneNumbers':
    case 'terms':
    case 'keywords':
    case 'nameTokens':
      $type = 'string_multiply';
      break;

    case 'profileUrl':
    case 'url':
    case 'href':
    case 'orgUrl':
    case 'doiUrl':
    case 'pubMedUrl':
    case 'webOfScienceUrl':
    case 'personalUrl':
    case 'researchUrl':
    case 'clinicalTrialsUrl':
      $type = 'link';
      break;

    case 'capFaculty':
    case 'capStaff':
    case 'capPostdoc':
    case 'capMdStudent':
    case 'capMsStudent':
    case 'capPhdStudent':
    case 'physician':
    case 'primaryAlias':
    case 'ongoingProject':
    case 'studentInvolvementAvailable':
    case 'independentStudyInd':
    case 'exactNameMatch':
    case 'value':
    case 'academicInstituteDisplay':
    case 'bannerDisplay':
    case 'principalInvestigator':
    case 'placeholder':
    case 'featured':
    case 'partialNameMatch':
    case 'showFeaturedPublicationsFirst':
      $type = 'boolean';
      break;

    case 'lastModified':
    case 'startYear':
    case 'endYear':
    case 'year':
    case 'startDate':
    case 'endDate':
    case 'lastModifiedDate':
    case 'firstPublished':
    case 'patentDate':
      $type = 'date';
      break;

    case 'profileId':
    case 'ordinal':
    case 'weight':
    case 'publicationId':
      $type = 'integer';
      break;

    case 'professionalInterests':
    case 'currentRoleAtStanford':
    case 'bio':
    case 'fullText':
    case 'shortText':
    case 'terseText':
    case 'brief':
    case 'full':
      $type = 'text';
      break;

    case 'activeAffiliations':
    case 'administrativeAppointments':
    case 'advisees':
    case 'advisor':
    case 'affiliations':
    case 'aliases':
    case 'alternateContact':
    case 'areas':
    case 'associatedPrograms':
    case 'big':
    case 'bigger':
    case 'clerkships':
    case 'clinicalContacts':
    case 'clinicalInterests':
    case 'collaborators':
    case 'communityAndInternationalWork':
    case 'concentrations':
    case 'contact':
    case 'courses':
    case 'coursesTaught':
    case 'currentResearchInterests':
    case 'cv':
    case 'disclosureStatement':
    case 'documents':
    case 'education':
    case 'flags':
    case 'graduateAndFellowshipPrograms':
    case 'honorsAndAwards':
    case 'independentStudyCourses':
    case 'industryRelationships':
    case 'internetLinks':
    case 'labAffiliations':
    case 'legal':
    case 'links':
    case 'longTitle':
    case 'maintainers':
    case 'media':
    case 'membershipOrganizations':
    case 'mentor':
    case 'names':
    case 'nihBiosketch':
    case 'organization':
    case 'origCourses':
    case 'postdoctoralAdvisees':
    case 'preferred':
    case 'presentations':
    case 'primaryContact':
    case 'professionalOrganizations':
    case 'profilePatents':
    case 'profilePhotos':
    case 'projects':
    case 'projectType':
    case 'publications':
    case 'publicationTags':
    case 'researchProjects':
    case 'resume':
    case 'serviceWork':
    case 'shortTitle':
    case 'similarProfiles':
    case 'small':
    case 'square':
    case 'stanfordAdvisors':
    case 'status':
    case 'supervisors':
    case 'titles':
    case 'visibility':
    case 'workExperience':
      $type = 'field_collection';
      break;
  }

  return $type;
}

/**
 * Returns Drupal base field definition based of JSON field type.
 */
function _cap_api_get_field_base_def($type, $name) {
  $info = FALSE;
  switch ($type) {
    case 'link':
      $info = array(
        'active' => 1,
        'cardinality' => 1,
        'deleted' => 0,
        'entity_types' => array(),
        'field_name' => $name,
        'foreign keys' => array(),
        'indexes' => array(),
        'locked' => 0,
        'module' => 'link',
        'settings' => array(
          'attributes' => array(
            'class' => '',
            'rel' => '',
            'target' => 'default',
          ),
          'display' => array(
            'url_cutoff' => 80,
          ),
          'enable_tokens' => 1,
          'title' => 'optional',
          'title_maxlength' => 128,
          'title_value' => '',
          'url' => 0,
        ),
        'translatable' => 0,
        'type' => 'link_field',
      );
      break;

    case 'date':
      $info = array(
        'active' => 1,
        'cardinality' => 1,
        'deleted' => 0,
        'entity_types' => array(),
        'field_name' => $name,
        'foreign keys' => array(),
        'indexes' => array(),
        'locked' => 0,
        'module' => 'date',
        'settings' => array(
          'cache_count' => 4,
          'cache_enabled' => 0,
          'granularity' => array(
            'day' => 'day',
            'hour' => 0,
            'minute' => 0,
            'month' => 'month',
            'second' => 0,
            'year' => 'year',
          ),
          'timezone_db' => '',
          'todate' => '',
          'tz_handling' => 'none',
        ),
        'translatable' => 0,
        'type' => 'datestamp',
      );
      break;

    case 'string':
      $info = array(
        'active' => 1,
        'cardinality' => 1,
        'deleted' => 0,
        'entity_types' => array(),
        'field_name' => $name,
        'foreign keys' => array(
          'format' => array(
            'columns' => array(
              'format' => 'format',
            ),
            'table' => 'filter_format',
          ),
        ),
        'indexes' => array(
          'format' => array(
            0 => 'format',
          ),
        ),
        'locked' => 0,
        'module' => 'text',
        'settings' => array(
          'max_length' => 255,
        ),
        'translatable' => 0,
        'type' => 'text',
      );
      break;

    case 'string_multiply':
      $info = array(
        'active' => 1,
        'cardinality' => -1,
        'deleted' => 0,
        'entity_types' => array(),
        'field_name' => $name,
        'foreign keys' => array(
          'format' => array(
            'columns' => array(
              'format' => 'format',
            ),
            'table' => 'filter_format',
          ),
        ),
        'indexes' => array(
          'format' => array(
            0 => 'format',
          ),
        ),
        'locked' => 0,
        'module' => 'text',
        'settings' => array(
          'max_length' => 255,
        ),
        'translatable' => 0,
        'type' => 'text',
      );
      break;

    case 'text':
      $info = array(
        'active' => 1,
        'cardinality' => 1,
        'deleted' => 0,
        'entity_types' => array(),
        'field_name' => $name,
        'foreign keys' => array(
          'format' => array(
            'columns' => array(
              'format' => 'format',
            ),
            'table' => 'filter_format',
          ),
        ),
        'indexes' => array(
          'format' => array(
            0 => 'format',
          ),
        ),
        'locked' => 0,
        'module' => 'text',
        'settings' => array(),
        'translatable' => 0,
        'type' => 'text_long',
      );
      break;

    case 'integer':
      $info = array(
        'active' => 1,
        'cardinality' => 1,
        'deleted' => 0,
        'entity_types' => array(),
        'field_name' => $name,
        'foreign keys' => array(),
        'indexes' => array(),
        'locked' => 0,
        'module' => 'number',
        'settings' => array(),
        'translatable' => 0,
        'type' => 'number_integer',
      );
      break;

    case 'field_collection':
      $info = array(
        'active' => 1,
        'cardinality' => -1,
        'deleted' => 0,
        'entity_types' => array(),
        'field_name' => $name,
        'foreign keys' => array(),
        'indexes' => array(),
        'locked' => 0,
        'module' => 'field_collection',
        'settings' => array(
          'hide_blank_items' => 1,
          'path' => '',
        ),
        'translatable' => 0,
        'type' => 'field_collection',
      );
      break;

    case 'boolean':
      $info = array(
        'active' => 1,
        'cardinality' => 1,
        'deleted' => 0,
        'entity_types' => array(),
        'field_name' => $name,
        'foreign keys' => array(),
        'indexes' => array(
          'value' => array(
            0 => 'value',
          ),
        ),
        'locked' => 0,
        'module' => 'list',
        'settings' => array(
          'allowed_values' => array(
            0 => '',
            1 => '',
          ),
          'allowed_values_function' => '',
        ),
        'translatable' => 0,
        'type' => 'list_boolean',
      );
      break;
  }

  return $info;
}

/**
 * Generates instance info for profile fields.
 *
 * @param $type
 * @param $name
 * @param $label
 *
 * @return array|FALSE
 */
function _cap_api_get_field_instance_def($type, $name, $label, $fc_field = FALSE) {
  $info = FALSE;
  $label = check_plain($label);
  switch ($type) {
    case 'link':
      $info = array(
        'bundle' => empty($fc_field) ? 'cap_faculty_profile' : $fc_field,
        'default_value' => NULL,
        'deleted' => 0,
        'description' => '',
        'display' => array(
          'default' => array(
            'label' => 'above',
            'module' => 'link',
            'settings' => array(),
            'type' => 'link_default',
          ),
        ),
        'entity_type' => empty($fc_field) ? 'node' : 'field_collection_item',
        'field_name' => $name,
        'label' => $label,
        'required' => 0,
        'settings' => array(
          'attributes' => array(
            'class' => '',
            'configurable_title' => 0,
            'rel' => '',
            'target' => 'default',
            'title' => '',
          ),
          'display' => array(
            'url_cutoff' => 80,
          ),
          'enable_tokens' => 1,
          'rel_remove' => 'default',
          'title' => 'none',
          'title_maxlength' => 128,
          'title_value' => '',
          'url' => 0,
          'user_register_form' => FALSE,
          'validate_url' => 1,
        ),
        'widget' => array(
          'active' => 0,
          'module' => 'link',
          'settings' => array(),
          'type' => 'link_field',
        ),
      );
      break;

    case 'date':
      $info = array(
        'bundle' => empty($fc_field) ? 'cap_faculty_profile' : $fc_field,
        'default_value' => NULL,
        'deleted' => 0,
        'description' => '',
        'display' => array(
          'default' => array(
            'label' => 'above',
            'module' => 'date',
            'settings' => array(
              'format_type' => 'long',
              'fromto' => 'both',
              'multiple_from' => '',
              'multiple_number' => '',
              'multiple_to' => '',
            ),
            'type' => 'date_default',
          ),
        ),
        'entity_type' => empty($fc_field) ? 'node' : 'field_collection_item',
        'field_name' => $name,
        'label' => $label,
        'required' => 0,
        'settings' => array(
          'default_value' => 'now',
          'default_value2' => 'same',
          'default_value_code' => '',
          'default_value_code2' => '',
          'user_register_form' => FALSE,
        ),
        'widget' => array(
          'active' => 1,
          'module' => 'date',
          'settings' => array(
            'display_all_day' => 0,
            'increment' => 15,
            'input_format' => 'm/d/Y - H:i:s',
            'input_format_custom' => '',
            'label_position' => 'above',
            'text_parts' => array(),
            'year_range' => '-3:+3',
          ),
          'type' => 'date_select',
        ),
      );
      break;

    case 'string':
    case 'string_multiply':
      $info = array(
        'bundle' => empty($fc_field) ? 'cap_faculty_profile' : $fc_field,
        'default_value' => NULL,
        'deleted' => 0,
        'description' => '',
        'display' => array(
          'default' => array(
            'label' => 'above',
            'module' => 'text',
            'settings' => array(),
            'type' => 'text_default',
          ),
        ),
        'entity_type' => empty($fc_field) ? 'node' : 'field_collection_item',
        'field_name' => $name,
        'label' => $label,
        'required' => 0,
        'settings' => array(
          'text_processing' => 0,
          'user_register_form' => FALSE,
        ),
        'widget' => array(
          'active' => 1,
          'module' => 'text',
          'settings' => array(
            'size' => 60,
          ),
          'type' => 'text_textfield',
        ),
      );
      break;

    case 'text':
      $info = array(
        'bundle' => empty($fc_field) ? 'cap_faculty_profile' : $fc_field,
        'default_value' => NULL,
        'deleted' => 0,
        'description' => '',
        'display' => array(
          'default' => array(
            'label' => 'above',
            'module' => 'text',
            'settings' => array(),
            'type' => 'text_default',
          ),
        ),
        'entity_type' => empty($fc_field) ? 'node' : 'field_collection_item',
        'field_name' => $name,
        'label' => $label,
        'required' => 0,
        'settings' => array(
          'text_processing' => 0,
          'user_register_form' => FALSE,
        ),
        'widget' => array(
          'active' => 1,
          'module' => 'text',
          'settings' => array(
            'rows' => 5,
          ),
          'type' => 'text_textarea',
        ),
      );
      break;

    case 'integer':
      $info = array(
        'bundle' => empty($fc_field) ? 'cap_faculty_profile' : $fc_field,
        'default_value' => NULL,
        'deleted' => 0,
        'description' => '',
        'display' => array(
          'default' => array(
            'label' => 'above',
            'module' => 'number',
            'settings' => array(
              'decimal_separator' => '.',
              'prefix_suffix' => TRUE,
              'scale' => 0,
              'thousand_separator' => ' ',
            ),
            'type' => 'number_integer',
          ),
        ),
        'entity_type' => empty($fc_field) ? 'node' : 'field_collection_item',
        'field_name' => $name,
        'label' => $label,
        'required' => 0,
        'settings' => array(
          'max' => '',
          'min' => '',
          'prefix' => '',
          'suffix' => '',
          'user_register_form' => FALSE,
        ),
        'widget' => array(
          'active' => 0,
          'module' => 'number',
          'settings' => array(),
          'type' => 'number',
        ),
      );
      break;

    case 'boolean':
      $info = array(
        'bundle' => empty($fc_field) ? 'cap_faculty_profile' : $fc_field,
        'default_value' => array(
          0 => array(
            'value' => 0,
          ),
        ),
        'deleted' => 0,
        'description' => '',
        'display' => array(
          'default' => array(
            'label' => 'above',
            'module' => 'list',
            'settings' => array(),
            'type' => 'list_default',
          ),
        ),
        'entity_type' => empty($fc_field) ? 'node' : 'field_collection_item',
        'field_name' => $name,
        'label' => $label,
        'required' => 0,
        'settings' => array(
          'user_register_form' => FALSE,
        ),
        'widget' => array(
          'active' => 1,
          'module' => 'options',
          'settings' => array(
            'display_label' => 1,
          ),
          'type' => 'options_onoff',
        ),
      );
      break;

    case 'field_collection':
      $info = array(
        'bundle' => empty($fc_field) ? 'cap_faculty_profile' : $fc_field,
        'default_value' => NULL,
        'deleted' => 0,
        'description' => '',
        'display' => array(
          'default' => array(
            'label' => 'above',
            'module' => 'field_collection',
            'settings' => array(
              'add' => 'Add',
              'delete' => 'Delete',
              'description' => TRUE,
              'edit' => 'Edit',
              'view_mode' => 'full',
            ),
            'type' => 'field_collection_view',
          ),
        ),
        'entity_type' => empty($fc_field) ? 'node' : 'field_collection_item',
        'field_name' => $name,
        'label' => $label,
        'required' => 0,
        'settings' => array(
          'user_register_form' => FALSE,
        ),
        'widget' => array(
          'active' => 0,
          'module' => 'field_collection',
          'settings' => array(),
          'type' => 'field_collection_embed',
        ),
      );
      break;
  }

  return $info;
}

function _cap_api_log_field($field_name) {
  $record = array('field_name' => $field_name);
  drupal_write_record('cap_api_fields', $record);
  watchdog('stanford_cap_api', 'Field @field was created by stanford_cap_api module.', array('@field' => $field_name));
}

/**
 * Generates CAP network profile URL.
 *
 * @todo Remove this when appropriate field would be available.
 *
 * @param array $profile
 *   CAP network profile.
 *
 * @return string
 *   CAP network profile URL.
 */
function _cap_api_format_cap_profile_url($profile) {
  $href = 'https://med.stanford.edu/profiles/';
  if (!empty($profile['names']['legal'])) {
    $href .= 'stanford/';
    $href .= $profile['names']['legal']['firstName'];
    $href .= '_' . $profile['names']['legal']['lastName'];
  }
  elseif (!empty($profile['names']['preferred'])) {
    $href .= 'stanford/';
    $href .= $profile['names']['preferred']['firstName'];
    $href .= '_' . $profile['names']['preferred']['lastName'];
  }

  return $href;
}

/**
 * Convert profile subfield name to drupal subfield name.
 *
 * @param $subfield
 *
 * @return string
 */
function _cap_api_get_subfield_name($subfield) {
  return _cap_api_generate_field_name($subfield, 'cap_fc_');
}

/**
 * @param $subfields
 * @param $node_field_name
 */
function _cap_api_sync_subfields($subfields, $node_field_name) {
  // Subfields could come in 2 types: 1) array of different fields(e.g. just a
  //fields set), in this case indexes are field names; 2) array of single field
  // values - in this case this array is keyed with indexes.
  // With "array_key_exists(0, $subfields)" we checking for second case and
  // selecting first field just to get structure.
  if (is_array($subfields) && !empty($subfields) && array_key_exists(0, $subfields)) {
    $subfields = array_shift($subfields);
  }
  foreach ($subfields as $subfield => $subfield_data) {
    $fc_field_name = _cap_api_get_subfield_name($subfield);
    $subfield_type = _cap_api_get_field_type($subfield);
    $subfield_info = field_info_field($fc_field_name);
    if (empty($subfield_info)) {
      $subfield_info = _cap_api_get_field_base_def($subfield_type, $fc_field_name);
      if (!empty($subfield_info)) {
        field_create_field($subfield_info);
        // Logging field creation.
        _cap_api_log_field($node_field_name);
      }
    }
    $subfield_instance = field_info_instance('field_collection_item', $fc_field_name, $node_field_name);
    if (empty($subfield_instance)) {
      $subfield_instance = _cap_api_get_field_instance_def($subfield_type, $fc_field_name, $subfield, $node_field_name);
      field_create_instance($subfield_instance);
    }
    if ($subfield_type == 'field_collection') {
      _cap_api_sync_subfields($subfield_data, $fc_field_name);
    }
  }
}

/**
 * @param $field_name
 * @param string $prefix
 *
 * @return string
 */function _cap_api_generate_field_name($field_name, $prefix = 'cap_') {
  $node_field_name = $prefix . drupal_strtolower($field_name);
  if (drupal_strlen($node_field_name) > 32) {
    $node_field_name = substr($node_field_name, 0, 32);
  }

  return $node_field_name;
}

function _cap_api_save_field(&$entity, &$wrapper, $field_name, $field_data, $subfield = FALSE){
  $field_type = _cap_api_get_field_type($field_name);
  $drupal_field_name = $subfield ? _cap_api_get_subfield_name($field_name) : _cap_api_generate_field_name($field_name);
  switch ($field_type) {
    case 'link':
      $wrapper->{$drupal_field_name}->set(array('url' => $field_data));
      break;

    case 'date':
      if(is_string($field_data)) {
        $wrapper->{$drupal_field_name}->set(strtotime($field_data));
      }
      elseif(!empty($field_data['value'])){
        $wrapper->{$drupal_field_name}->set(strtotime($field_data['value']));
      }
      break;

    case 'string':
      if(is_string($field_data)) {
        // @todo Sometimes 'label' field just a bit longer then we expect,
        // e.g. 264-270 chars, so we truncating data to 255 until we get schema.
        $wrapper->{$drupal_field_name}->set(substr($field_data, 0, 255));
      }
      elseif(is_array($field_data) && !empty($field_data['html'])){
        $wrapper->{$drupal_field_name}->set(substr($field_data['html'], 0, 255));
      }
      break;

    case 'string_multiply':
      $values = array();
      foreach ($field_data as $field) {
        $values[] = $field;
      }
      $wrapper->{$drupal_field_name}->set($values);
      break;

    case 'text':
      $wrapper->{$drupal_field_name}->set($field_data);
      break;

    case 'integer':
      $wrapper->{$drupal_field_name}->set($field_data);
      break;

    case 'boolean':
      $wrapper->{$drupal_field_name}->set($field_data);
      break;

    case 'field_collection':
      // This is multivalue field collection.
      if (is_array($field_data) && !empty($field_data) && array_key_exists(0, $field_data)) {
        foreach ($field_data as $fc_subfield_data) {
          _cap_api_save_field($entity, $wrapper, $field_name, $fc_subfield_data, $subfield);
        }
      }
      else {
        if(!empty($field_data)) {
          $fc_item = entity_create('field_collection_item', array('field_name' => $drupal_field_name));
          $entity_type = method_exists($entity, 'entityType') ? 'field_collection_item' : 'node';
          $fc_item->setHostEntity($entity_type, $entity);
          $fc_item->save(TRUE);
          $fc_wrapper = entity_metadata_wrapper('field_collection_item', $fc_item);
          foreach ($field_data as $fc_subfield => $fc_subfield_data) {
            _cap_api_save_field($fc_item, $fc_wrapper, $fc_subfield, $fc_subfield_data, TRUE);
          }
          $fc_item->save(TRUE);
        }
      }
      break;
  }
}
